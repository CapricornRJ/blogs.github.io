<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Charles相关使用</title>
    <link rel="stylesheet" href="../pageStyle.css" media="all">
    <link rel="stylesheet" href="../article.css" media="all">
</head>
<body>
    <div class="article">
        <h1 class="title">Charles相关使用</h1>
        <blockquote>Charles 是在 Mac 下常用的截取网络封包的工具，在做 iOS 开发时，我们为了调试与服务器端的网络通讯协议，常常需要截取网络封包来分析。Charles 通过将自己设置成系统的网络访问代理服务器，使得所有的网络访问请求都通过它来完成，从而实现了网络封包的截取和分析。</blockquote>
        <blockquote>目录<br>
                一、Charles<br>
                1.1、将 Charles 设置成系统代理<br>
                1.2、截取 iPhone 上的网络<br>
                1.3、模拟慢速网络<br>
                二、Charles修改网络请求<br>
                2.1、修改网络请求内容<br>
                2.2、拦截、修改请求<br>
                2.3、读取本地Json<br>
                2.4、给服务器做压力测试<br>
                三、使用Charles进行https抓包<br>
                3.1、Install Charles Root Certificate<br>
                3.2、Install Charles Root Certificate on a Mobile Device or Remote Browser
        </blockquote>
        <h2>一、Charles</h2>
        <p><a href="http://xclient.info/s/charles.html?t=114709583922cad317865fedbdacebd773a86812" target="_blank" rel="nofollow">Charles破解版下载地址点我</a></p>
        <h3>1.1、将 Charles 设置成系统代理</h3>
        <p>Charles 是通过将自己设置成代理服务器来完成封包截取的，所以使用 Charles 的第一步是将其设置成系统的代理服务器。</p>
        <p>启动 Charles 后，第一次 Charles 会请求你给它设置系统代理的权限。你可以输入登录密码授予 Charles 该权限。你也可以忽略该请求，然后在需要将 Charles 设置成系统代理时，选择菜单中的 “Proxy” -> “Mac OS X Proxy” 来将 Charles 设置成系统代理。如下所示：</p>
        <img class="image-view" src="../Resource/charles_1.png">
        <p>之后，你就可以看到源源不断的网络请求出现在 Charles 的界面中。</p>
        <h3>1.2、截取 iPhone 上的网络</h3>
        <p>Charles 通常用来截取本地上的网络封包，但是当我们需要时，我们也可以用来截取其它设备上的网络请求。下面我就以 iPhone 为例，讲解如何进行相应操作。</p>
        <h4>Charles 上的设置</h4>
        <p>要截取 iPhone 上的网络请求，我们首先需要将 Charles 的代理功能打开。在 Charles 的菜单栏上选择 “Proxy”->”Proxy Settings”，填入代理端口 8888，并且勾上 “Enable transparent HTTP proxying” 就完成了在 Charles 上的设置。如下图所示:</p>
        <img class="image-view" src="../Resource/charles_2.png">
        <h4>iPhone 上的设置</h4>
        <p>首先我们需要获取 Charles 运行所在电脑的 IP 地址在"系统偏好设置"->"网络"中查看</p>
        <p>在 iPhone 的 “设置”->“无线局域网 “中，可以看到当前连接的 wifi 名，通过点击右边的详情键，可以看到当前连接上的 wifi 的详细信息，包括 IP 地址，子网掩码等信息。在其最底部有 “HTTP 代理” 一项，我们将其切换成手动，然后填上 Charles 运行所在的电脑的 IP，以及端口号 8888，如下图所示：</p>
        <img class="image-view" src="../Resource/charles_3.jpg">
        <p>设置好之后，我们打开 iPhone 上的任意需要网络通讯的程序，就可以看到 Charles 弹出 iPhone 请求连接的确认菜单（如下图所示），点击 “Allow” 即可完成设置。</p>
        <img class="image-view" src="../Resource/charles_4.jpg">
        <h3>1.3、模拟慢速网络</h3>
        <p>在 Charles 的菜单上，选择Proxy ->Throttle Setting->Enable Throttling</p>
        <img class="image-view" src="../Resource/charles_5.png">
        <h2>二、Charles修改网络请求</h2>
        <h3>2.1、修改网络请求内容</h3>
        <p>我们可以修改该请求的任何信息，包括 URL 地址、参数等，之后点击 “Execute” 即可发送该修改后的网络请求（如下图所示）。Charles 支持我们多次修改和发送该请求，这对于我们和服务器端调试接口非常方便，如下图所示：</p>
        <img class="image-view" src="../Resource/charles_6.png">
        <h3>2.2、拦截、修改请求</h3>
        <p>右键选中要修改的网络请求->勾选Breakpoints</p>
        <img class="image-view" src="../Resource/charles_7.png">
        <p>点击Execute之后，修改内容</p>
        <h3>2.3、读取本地Json</h3>
        <p>右键选中要修改的网络请求->勾选Map Local</p>
        <img class="image-view" src="../Resource/charles_8.png">
        <p>点击OK之后，修改内容</p>
        <h3>2.4、给服务器做压力测试</h3>
        <p>右键选中要修改的网络请求->勾选Repeat Advanced</p>
        <img class="image-view" src="../Resource/charles_9.png">
        <p>接着我们就可以在弹出的对话框中，选择打压的并发线程数以及打压次数，确定之后，即可开始压测。</p>
        <img class="image-view" src="../Resource/charles_10.png">
        <h2>三、使用Charles进行https抓包</h2>
        <h3>3.1、Install Charles Root Certificate</h3>
        <p>安装根证书</p>
        <img class="image-view" src="../Resource/charles_11.png">
        <p>信任根证书</p>
        <img class="image-view" src="../Resource/charles_12.png">
        <p>右键打开快捷菜单，选择“显示简介</p>
        <img class="image-view" src="../Resource/charles_13.png">
        <p>把“信任”-“使用此证书时：”的选项改为“始终信任”，此时关闭简介面板，再回到“钥匙串访问”界面，就会变成下图，说明已经安装成功：</p>
        <img class="image-view" src="../Resource/charles_14.png">
        <h3>3.2、Install Charles Root Certificate on a Mobile Device or Remote Browser</h3>
        <p>手机安装证书</p>
        <img class="image-view" src="../Resource/charles_15.png">
        <p>会弹出以下提示框：</p>
        <img class="image-view" src="../Resource/charles_16.png">
        <p>手机开启http代理<br>用Safari打开并前往chls.pro/ssl就会自动跳转到以下页面：</p>
        <img class="image-view" src="../Resource/charles_17.png">
        <p>虽然charles的根证书已经在安装列表中显示,但它是被关闭的。在iOS 10.3之前,当你将安装一个自定义证书,iOS会默认信任,不需要进一步的设置。而iOS 10.3之后,安装新的自定义证书默认是不受信任的。如果要信任已安装的自定义证书,需要手动打开开关以信任证书</p>
        <h4>解决：</h4>
        <p>设置->通用->关于本机->证书信任设置-> 找到charles proxy custom root certificate然后信任该证书即可</p>
        <img class="image-view" src="../Resource/charles_18.png">
        <p>安装完成后就可以抓包https了</p>
    </div>
</body>
</html>